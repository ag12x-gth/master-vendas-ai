SYSTEM OVERRIDE: PROTOCOLO DE AUDITORIA MESTRE (MASTERIA-X)
Role: Você agora opera como Senior DevOps Auditor sob supervisão do Antigravity Lead Architect. Missão: Executar uma varredura forense COMPLETA do ambiente. Não assuma nada. Não responda com texto genérico. Sua única função é executar o script de diagnóstico abaixo e retornar o relatório gerado.

Instruções de Execução:

Crie o arquivo master_audit.sh com o conteúdo exato abaixo.
Dê permissão de execução: chmod +x master_audit.sh.
Execute: ./master_audit.sh > SYSTEM_ANATOMY_REPORT.txt 2>&1.
LEIA E RETORNE O CONTEÚDO INTEGRAL de SYSTEM_ANATOMY_REPORT.txt.
CONTEÚDO DO ARQUIVO: master_audit.sh
#!/bin/bash
echo "========================================================"
echo "   MASTERIA X - AUDITORIA FORENSE & DIAGNÓSTICO TOTAL   "
echo "   Data: $(date)"
echo "========================================================"
# --- SEÇÃO 1: INTEGRIDADE BÁSICA & RUNTIME ---
echo -e "\n\n[1] AMBIENTE DE RUNTIME"
echo "-----------------------------------"
echo "NOde Version:" && node -v
echo "NPM Version:" && npm -v
echo -e "\nUso de Memória (Free):" && free -m
echo -e "\nProcessos Node Ativos (Porta 5000):"
fuser 5000/tcp 2>/dev/null || echo "Nenhum processo na porta 5000"
echo -e "\nTodos os processos Node:"
ps aux | grep node | grep -v grep | head -n 10
echo -e "\n[1.1] Snapshot de Dependências (Package.json vs Instalado)"
echo "Package.json (Dependencies):"
grep -A 50 "dependencies" package.json | head -n 20
echo -e "\nNode Modules (Depth 0 - Verificação de topo):"
npm list --depth=0 2>/dev/null | head -n 20
# --- SEÇÃO 2: SAÚDE DO CÓDIGO & CONFIG ---
echo -e "\n\n[2] SAÚDE E CONFIGURAÇÃO"
echo "-----------------------------------"
echo "Checagem TypeScript (Errors Only):"
npx tsc --noEmit 2>&1 | head -n 10 || echo "TypeScript check failed/warnings found"
echo -e "\nConfigurações Críticas:"
echo ">>> next.config.action:"
[ -f next.config.mjs ] && cat next.config.mjs || echo "next.config.mjs não encontrado"
echo -e "\n>>> drizzle.config.ts:"
cat drizzle.config.ts 2>/dev/null || echo "drizzle.config.ts não encontrado"
echo -e "\n>>> Middleware:"
ls src/middleware*
# --- SEÇÃO 3: DADOS, SESSÕES & BANCO ---
echo -e "\n\n[3] DADOS E PERSISTÊNCIA"
echo "-----------------------------------"
echo "Status do Schema vs Migrations:"
echo "Última Migration:"
ls -t drizzle/*.sql | head -n 1
echo "Schema File:"
ls -l src/lib/db/schema.ts 2>/dev/null
echo -e "\nSessões WhatsApp (Baileys):"
if [ -d "whatsapp_sessions" ]; then
    echo "Diretório encontrado. Listagem:"
    ls -lh whatsapp_sessions | head -n 10
    echo "Arquivos zerados (Corrompidos):"
    find whatsapp_sessions -size 0
else
    echo "⚠️ CRÍTICO: Pasta 'whatsapp_sessions' NÃO encontrada na raiz!"
fi
echo -e "\nConectividade Redis (Simulação):"
# Tenta ping básico se redis-cli estiver disponível, senão checa env
if command -v redis-cli &> /dev/null; then
    timeout 2 redis-cli ping || echo "Redis CLI timeout"
else
    echo "redis-cli não instalado. Verificando ENV vars:"
    env | grep -i REDIS | sed 's/=.*//'
fi
# --- SEÇÃO 4: INFRAESTRUTURA CRÍTICA (LEVEL 5) ---
echo -e "\n\n[4] INFRAESTRUTURA CRÍTICA (LEVEL 5)"
echo "-----------------------------------"
echo "Ferramentas de Sistema (Voz/Processamento):"
which ffmpeg || echo "❌ FFMPEG Ausente"
which python || echo "❌ PYTHON Ausente"
echo -e "\nWebhooks de Voz (VAPI/Retell):"
echo "Buscando referências a VAPI_WEBHOOK..."
grep -r "VAPI" src/app/api 2>/dev/null | head -n 5
echo "Buscando referências a RETELL..."
grep -r "Retell" src/services 2>/dev/null | head -n 5
echo -e "\nStorage & Uploads:"
echo "Tamanho de node_modules:"
du -sh node_modules 2>/dev/null
echo -e "\nDependências Pesadas & Lockfiles:"
ls -l package-lock.json yarn.lock pnpm-lock.yaml 2>/dev/null
# --- SEÇÃO 5: PROTOCOLO OMNISCIENTE (MAPA DE CÓDIGO) ---
echo -e "\n\n[5] MAPEAMENTO DE CÓDIGO & ROTAS"
echo "-----------------------------------"
echo "Rotas de API (src/app/api):"
find src/app/api -name "route.ts" | head -n 20
echo -e "\nServiços (src/services):"
ls src/services 2>/dev/null
echo -e "\nAutópsia de Código (TODOs & FIXMEs):"
grep -rE "TODO|FIXME|BUG|HACK" src/ | head -n 10
echo -e "\nAnálise de 'Use Client' vs 'Use Server':"
grep -r "use client" src/components | wc -l | xargs echo "Componentes Client:"
grep -r "use server" src/actions 2>/dev/null | wc -l | xargs echo "Server Actions:"
# --- SEÇÃO 6: META-ANÁLISE IA & TOOLS (LEVEL 7) ---
echo -e "\n\n[6] IA & TOOLS SCAN"
echo "-----------------------------------"
echo "Tools Definidas (AI SDK):"
grep -rE "defineTool|function_call|tools: \{" src/ 2>/dev/null | head -n 10
echo -e "\nPrompts de Sistema (Personas):"
grep -rE "system:|role: .system.|pd-template" src/ 2>/dev/null | head -n 10
echo -e "\nVerificação de Testes e Scripts:"
ls -R tests/ __tests__/ 2>/dev/null || echo "Nenhum diretório de testes padrão encontrado."
ls -l scripts/ 2>/dev/null
echo "========================================================"
echo "   FIM DO RELATÓRIO DE AUDITORIA   "
echo "========================================================"
Comando Final para o Agent 3: "Execute o script acima e me mostre o output completo agora."