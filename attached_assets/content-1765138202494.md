## Resumo da API

Esta API permite criar agentes de IA para atendimento telefonico automatizado. Integra com Retell.ai (voz IA), Twilio (telefonia) e OpenAI (LLM).

### Dados de Conexao

| Item | Valor |
| --- | --- |
| URL Base | `https://[seu-app].replit.app` |
| Autenticacao | Header `X-API-KEY: sua_chave` |
| Formato | JSON |
| Porta | 5000 |

## Endpoints Disponiveis

### Health (Publico)

| Metodo | Endpoint | Descricao |
| --- | --- | --- |
| GET | `/health` | Status do servidor e banco de dados |

### Agentes de IA

| Metodo | Endpoint | Descricao |
| --- | --- | --- |
| GET | `/api/agents` | Listar todos os agentes |
| POST | `/api/agents` | Criar novo agente |
| GET | `/api/agents/:id` | Buscar agente por ID |
| PATCH | `/api/agents/:id` | Atualizar agente |
| DELETE | `/api/agents/:id` | Remover agente |

### Chamadas

| Metodo | Endpoint | Descricao |
| --- | --- | --- |
| GET | `/api/calls` | Listar historico de chamadas |
| GET | `/api/calls/analytics` | Metricas e estatisticas |
| POST | `/api/calls/test` | Iniciar chamada de teste |
| GET | `/api/calls/:id` | Detalhes de uma chamada |

### Organizacoes

| Metodo | Endpoint | Descricao |
| --- | --- | --- |
| GET | `/api/organizations` | Listar organizacoes |
| POST | `/api/organizations` | Criar organizacao |
| GET | `/api/organizations/:id` | Buscar organizacao |

### Configuracao

| Metodo | Endpoint | Descricao |
| --- | --- | --- |
| GET | `/api/config` | Ver configuracoes atuais |
| GET | `/api/config/status` | Status das integracoes |
| POST | `/api/config/test-voice-provider` | Testar Retell.ai |
| POST | `/api/config/test-telephony-provider` | Testar Twilio |
| POST | `/api/config/test-llm-provider` | Testar OpenAI |

### Webhooks (Publicos)

| Metodo | Endpoint | Descricao |
| --- | --- | --- |
| POST | `/api/webhooks/voice/call-events` | Eventos de chamada (Retell) |
| POST | `/api/webhooks/telephony/call-status` | Status de chamada (Twilio) |
| POST | `/api/webhooks/telephony/incoming-call` | Chamada recebida |
| POST | `/api/webhooks/custom/:orgId` | Webhook customizado |

## Criar Agente - Exemplo

```
POST /api/agents
Headers: X-API-KEY: sua_chave, Content-Type: application/json

Body:
{
  "name": "Atendente Virtual",
  "type": "inbound",
  "systemPrompt": "Voce e um atendente de suporte amigavel e prestativo.",
  "firstMessage": "Ola! Como posso ajudar?",
  "voiceId": "pt-BR-FranciscaNeural",
  "llmModel": "gpt-4",
  "temperature": 0.7
}

Resposta:
{
  "id": "uuid-do-agente",
  "name": "Atendente Virtual",
  "type": "inbound",
  "status": "active",
  "systemPrompt": "...",
  "voiceId": "pt-BR-FranciscaNeural",
  "llmProvider": "openai",
  "llmModel": "gpt-4",
  "temperature": 0.7,
  "createdAt": "2025-12-07T19:00:00.000Z"
}
```

### Campos do Agente

| Campo | Tipo | Obrigatorio | Descricao |
| --- | --- | --- | --- |
| name | string | Sim | Nome do agente |
| type | enum | Sim | inbound, outbound, transfer |
| systemPrompt | string | Sim | Instrucoes para o LLM |
| firstMessage | string | Nao | Mensagem inicial |
| voiceId | string | Nao | Voz do agente |
| llmModel | string | Nao | gpt-4, gpt-3.5-turbo |
| temperature | number | Nao | 0.0 a 1.0 |

## Iniciar Chamada - Exemplo

```
POST /api/calls/test
Headers: X-API-KEY: sua_chave, Content-Type: application/json

Body:
{
  "agentId": "uuid-do-agente",
  "toNumber": "+5511999999999"
}
```

## Analytics - Exemplo

```
GET /api/calls/analytics
Headers: X-API-KEY: sua_chave

Resposta:
{
  "totalCalls": 100,
  "totalDuration": 3600,
  "avgDuration": 36,
  "totalCost": 15.50,
  "callsByStatus": {
    "ended": 85,
    "ongoing": 5,
    "failed": 2,
    "initiated": 8
  }
}
```

## Codigo JavaScript

```
const API_URL = 'https://seu-app.replit.app';
const API_KEY = 'sua_chave';

const headers = {
  'X-API-KEY': API_KEY,
  'Content-Type': 'application/json'
};

// Listar agentes
async function listAgents() {
  const res = await fetch(API_URL + '/api/agents', { headers });
  return res.json();
}

// Criar agente
async function createAgent(data) {
  const res = await fetch(API_URL + '/api/agents', {
    method: 'POST',
    headers,
    body: JSON.stringify(data)
  });
  return res.json();
}

// Analytics
async function getAnalytics() {
  const res = await fetch(API_URL + '/api/calls/analytics', { headers });
  return res.json();
}

// Iniciar chamada
async function startCall(agentId, toNumber) {
  const res = await fetch(API_URL + '/api/calls/test', {
    method: 'POST',
    headers,
    body: JSON.stringify({ agentId, toNumber })
  });
  return res.json();
}
```

## Codigo Python

```
import requests

API_URL = 'https://seu-app.replit.app'
API_KEY = 'sua_chave'

headers = {
    'X-API-KEY': API_KEY,
    'Content-Type': 'application/json'
}

# Listar agentes
def list_agents():
    return requests.get(f'{API_URL}/api/agents', headers=headers).json()

# Criar agente
def create_agent(data):
    return requests.post(f'{API_URL}/api/agents', headers=headers, json=data).json()

# Analytics
def get_analytics():
    return requests.get(f'{API_URL}/api/calls/analytics', headers=headers).json()

# Iniciar chamada
def start_call(agent_id, to_number):
    return requests.post(f'{API_URL}/api/calls/test', headers=headers,
                         json={'agentId': agent_id, 'toNumber': to_number}).json()
```

## Tipos de Agentes Recomendados

| Agente | Tipo | Uso |
| --- | --- | --- |
| Recepcionista | inbound | Atender chamadas e direcionar |
| Suporte N1 | inbound | Resolver problemas comuns |
| Vendedor | outbound | Ligar para leads |
| Cobranca | outbound | Negociar pagamentos |
| Pesquisa | outbound | Coletar feedback |

## Erros Comuns

| Codigo | Erro | Solucao |
| --- | --- | --- |
| 401 | API Key ausente | Adicionar header X-API-KEY |
| 400 | Dados invalidos | Verificar campos obrigatorios |
| 404 | Nao encontrado | Verificar ID do recurso |

## Plano de Implementacao

Para construir um app de atendimento usando esta API:

### Fase 1: Setup (1-2 dias)

- Criar projeto (React, Next.js ou Python)
- Configurar variaveis de ambiente: VOICE\_API\_URL e VOICE\_API\_KEY
- Criar servico para consumir a API
- Testar conexao com /health

### Fase 2: Interface (3-5 dias)

- Dashboard com metricas (GET /api/calls/analytics)
- Pagina de agentes com CRUD completo
- Historico de chamadas
- Pagina de configuracoes

### Fase 3: Funcionalidades (2-3 dias)

- Iniciar chamadas de teste
- Ver transcricoes
- Receber webhooks de eventos
- Atualizacoes em tempo real

### Tempo Total Estimado: 8-13 dias

## Funcionalidades Existentes - Detalhamento Completo

### 1\. Gestao de Agentes de IA

Sistema completo para criar e gerenciar agentes de voz com inteligencia artificial:

- **Criacao de Agentes:** Defina nome, tipo (inbound/outbound/transfer), prompt de sistema, mensagem inicial, voz e modelo LLM
- **Configuracao de Voz:** Suporte a multiplas vozes via Retell.ai (11labs-Adrian, pt-BR-FranciscaNeural, etc.)
- **Modelos LLM:** GPT-4, GPT-4o, GPT-4o-mini via OpenAI
- **Personalizacao:** Temperature (0.0-1.0), max tokens, sensibilidade a interrupcoes, delay de resposta
- **Status:** Agentes podem estar ativos, inativos ou arquivados
- **Soft Delete:** Agentes sao arquivados, nao deletados permanentemente

### 2\. Sistema de Chamadas

Infraestrutura completa para iniciar, rastrear e analisar chamadas telefonicas:

- **Chamadas Outbound:** Iniciar ligacoes para qualquer numero via POST /api/calls/test
- **Chamadas Inbound:** Receber ligacoes automaticamente com agente IA
- **Rastreamento Completo:** Status (initiated, ongoing, ended, failed), duracao, custo
- **Transcricoes:** Salvas automaticamente apos termino da chamada
- **Gravacoes:** URL de gravacao disponivel via webhook
- **Variaveis Dinamicas:** Passar contexto personalizado para cada chamada

### 3\. Analytics e Metricas

Dashboard de dados em tempo real:

- **Total de Chamadas:** Contagem geral de todas as ligacoes
- **Duracao Total/Media:** Tempo total e medio das conversas
- **Custo Total:** Soma dos custos de todas as chamadas
- **Status Breakdown:** Chamadas finalizadas, em andamento, falhadas, iniciadas
- **Quality Score:** Pontuacao de qualidade (0-100) gerada automaticamente
- **Sentiment Score:** Analise de sentimento da conversa
- **Latency:** Tempo de resposta do agente em milissegundos
- **Interrupcoes:** Contagem de vezes que o usuario interrompeu o agente

### 4\. Multi-Tenancy (Organizacoes)

Suporte a multiplas organizacoes na mesma instancia:

- **Isolamento de Dados:** Cada organizacao ve apenas seus agentes e chamadas
- **Subdominios:** Cada organizacao pode ter subdominio unico
- **Configuracoes Proprias:** Credenciais de API separadas por organizacao
- **Telefonia Individual:** Setup de numero de telefone por organizacao

### 5\. Integracao Retell.ai

Conexao direta com a plataforma Retell para voz IA:

- **Criar Agentes Retell:** Sincronizar agentes locais com Retell.ai
- **Listar Agentes:** Ver todos os agentes criados na plataforma Retell
- **Importar Numeros:** Trazer numeros Twilio para uso no Retell
- **Iniciar Chamadas:** Fazer ligacoes diretamente via API Retell
- **LLM Customizado:** Criar configuracoes de LLM personalizadas

### 6\. Integracao Twilio

Telefonia completa via Twilio:

- **Listar Numeros:** Ver todos os numeros disponiveis na conta
- **Configurar Webhooks:** Setup automatico de callbacks para todos os numeros
- **SIP Trunk:** Configuracao completa de Elastic SIP Trunk para Retell
- **Status Callbacks:** Receber atualizacoes de status em tempo real

### 7\. Sistema de Webhooks

Endpoints publicos para receber eventos:

- **call\_started:** Chamada iniciada - atualiza status no banco
- **call\_ended:** Chamada finalizada - salva duracao, transcricao, gravacao
- **call\_analyzed:** Analise pos-chamada - quality score, sentiment, custo
- **Twilio Status:** Atualizacoes de status da operadora (ringing, in-progress, completed)
- **Incoming Call:** Chamada recebida - conecta automaticamente ao agente
- **Custom Webhook:** Endpoint por organizacao para integracao personalizada

### 8\. Configuracao e Testes

Gerenciamento de credenciais e validacao:

- **Ver Config:** Visualizar configuracoes atuais (sem expor secrets)
- **Status Integracoes:** Verificar se Retell, Twilio e OpenAI estao conectados
- **Testar Conexoes:** Validar cada provedor individualmente
- **Atualizar Credenciais:** Trocar API keys sem reiniciar o servidor

## Aplicacoes Possiveis - O Que Voce Pode Construir

### Atendimento ao Cliente

| Aplicacao | Descricao | Endpoints Utilizados |
| --- | --- | --- |
| Central de Atendimento 24/7 | Agente IA que atende chamadas a qualquer hora, resolve duvidas frequentes e escala para humanos quando necessario | POST /api/agents, webhooks/incoming-call |
| Triagem Automatica | Classificar chamadas por departamento e transferir para a area correta | Agente type: transfer, webhooks |
| FAQ por Telefone | Responder perguntas frequentes automaticamente via voz | POST /api/agents com systemPrompt detalhado |
| Suporte Tecnico N1 | Resolver problemas simples e coletar informacoes para tickets | Agente inbound + custom webhook |

### Vendas e Marketing

| Aplicacao | Descricao | Endpoints Utilizados |
| --- | --- | --- |
| Discador de Leads | Ligar automaticamente para lista de prospects com pitch personalizado | POST /api/calls/test com variaveis dinamicas |
| Qualificacao de Leads | Fazer perguntas de qualificacao e salvar respostas via transcricao | Agente outbound, GET /api/calls/:id |
| Follow-up Automatico | Ligar para clientes apos compra para feedback ou upsell | POST /api/calls/test agendado |
| Pesquisa de Satisfacao | NPS e CSAT por telefone com coleta automatica de dados | Agente outbound + analytics |

### Cobranca e Financeiro

| Aplicacao | Descricao | Endpoints Utilizados |
| --- | --- | --- |
| Lembrete de Pagamento | Ligar para clientes com boletos vencendo com tom amigavel | Agente outbound, variaveis dinamicas |
| Negociacao de Dividas | Oferecer opcoes de parcelamento e descontos via IA | Agente outbound com prompt de negociacao |
| Confirmacao de Transacoes | Ligar para confirmar compras suspeitas por seguranca | POST /api/calls/test com dados da transacao |

### Agendamentos e Lembretes

| Aplicacao | Descricao | Endpoints Utilizados |
| --- | --- | --- |
| Confirmacao de Consultas | Ligar para confirmar ou reagendar consultas medicas/servicos | Agente outbound com data/hora |
| Lembrete de Eventos | Avisar sobre eventos, reunioes ou compromissos | POST /api/calls/test agendado |
| Agendamento por Telefone | Permitir que clientes agendem servicos via chamada | Agente inbound + integracao calendario |

### Integracao com Sistemas

| Aplicacao | Descricao | Como Implementar |
| --- | --- | --- |
| CRM Integration | Sincronizar chamadas e transcricoes com Salesforce, HubSpot, etc. | Usar custom webhook para enviar dados |
| Helpdesk Automatico | Criar tickets no Zendesk/Freshdesk baseado em chamadas | Processar transcricoes via webhook |
| ERP Connection | Consultar status de pedidos e estoques durante chamadas | Variaveis dinamicas com dados do ERP |
| Notificacoes Push | Alertar equipe sobre chamadas importantes em tempo real | Custom webhook + Slack/Teams |

## Dados Armazenados por Chamada

Cada chamada salva automaticamente os seguintes dados no banco:

| Campo | Tipo | Descricao |
| --- | --- | --- |
| id | UUID | Identificador unico da chamada |
| agentId | UUID | Agente que atendeu/fez a chamada |
| retellCallId | string | ID da chamada no Retell.ai |
| direction | enum | inbound (recebida) ou outbound (realizada) |
| fromNumber | string | Numero de origem (+5511...) |
| toNumber | string | Numero de destino (+5511...) |
| status | enum | initiated, ongoing, ended, failed |
| startedAt | datetime | Inicio da chamada |
| endedAt | datetime | Fim da chamada |
| duration | integer | Duracao em segundos |
| transcript | JSON | Transcricao completa da conversa |
| recordingUrl | string | Link para audio da gravacao |
| disconnectReason | string | Motivo do encerramento (user\_hangup, agent\_hangup, etc.) |
| qualityScore | float | Pontuacao de qualidade (0-100) |
| sentimentScore | float | Analise de sentimento (-1 a 1) |
| latencyMs | integer | Tempo de resposta do agente |
| interruptionsCount | integer | Vezes que usuario interrompeu |
| cost | float | Custo da chamada em USD |
| metadata | JSON | Dados customizados da aplicacao |

## Fluxo Completo de uma Chamada Outbound

```
1. SEU APP: POST /api/calls/test
   Body: { "agentId": "abc123", "toNumber": "+5511999999999" }

2. API: Valida agente e numero
   - Se agentId nao informado, busca primeiro agente disponivel
   - Se nenhum agente existe, cria agente de teste automaticamente

3. API: Envia request para Retell.ai
   - POST https://api.retellai.com/v2/create-phone-call
   - from_number, to_number, override_agent_id

4. RETELL: Inicia chamada via Twilio
   - Twilio disca para o numero de destino
   - Conecta audio ao agente IA

5. WEBHOOK: call_started
   - API recebe evento e atualiza status para "ongoing"
   - Salva startedAt no banco

6. DURANTE A CHAMADA:
   - Retell processa audio em tempo real
   - Agente IA responde usando LLM configurado
   - Transcricao sendo gerada

7. WEBHOOK: call_ended
   - API recebe evento com duracao, transcricao, gravacao
   - Atualiza todos os campos no banco
   - Status muda para "ended"

8. WEBHOOK: call_analyzed (alguns minutos depois)
   - Retell envia analise da chamada
   - Quality score, sentiment, custo
   - API atualiza campos de analytics

9. SEU APP: GET /api/calls/:id
   - Busca todos os dados da chamada
   - Transcricao, gravacao, metricas disponiveis
```

## Fluxo Completo de uma Chamada Inbound

```
1. CLIENTE: Liga para seu numero Twilio
   - Ex: +5511912345678

2. TWILIO: Envia request para API
   - POST /api/webhooks/telephony/incoming-call
   - Body: CallSid, From, To

3. API: Processa chamada recebida
   - Identifica organizacao pelo numero
   - Busca agente inbound ativo
   - Cria registro de chamada no banco

4. API: Retorna TwiML para Twilio
   - Conecta audio ao stream do Retell
   - Cliente ouve mensagem de conexao

5. RETELL: Assume a conversa
   - Agente IA cumprimenta cliente
   - Inicia dialogo baseado no systemPrompt

6. WEBHOOKS: Mesmos eventos de outbound
   - call_started, call_ended, call_analyzed
   - Todos os dados salvos no banco

7. SEU APP: Monitora em tempo real
   - GET /api/calls (lista chamadas)
   - GET /api/calls/analytics (metricas)
```

## Vozes Disponiveis (Retell.ai)

| Voice ID | Idioma | Genero | Estilo |
| --- | --- | --- | --- |
| 11labs-Adrian | Ingles | Masculino | Profissional |
| 11labs-Rachel | Ingles | Feminino | Amigavel |
| pt-BR-FranciscaNeural | Portugues BR | Feminino | Natural |
| pt-BR-AntonioNeural | Portugues BR | Masculino | Natural |
| es-ES-ElviraNeural | Espanhol | Feminino | Natural |
| es-MX-DaliaNeural | Espanhol MX | Feminino | Natural |

Consulte a documentacao Retell.ai para lista completa de vozes disponiveis.

## Exemplo de Prompts para Agentes

### Atendimento ao Cliente

```
Voce e a Ana, assistente virtual da empresa XYZ.
Seu objetivo e ajudar clientes com duvidas sobre produtos e servicos.
Seja sempre educada, paciente e prestativa.
Se nao souber responder algo, ofereca transferir para um atendente humano.
Nunca invente informacoes sobre precos ou disponibilidade.
```

### Vendas Outbound

```
Voce e o Carlos, consultor de vendas da empresa ABC.
Voce esta ligando para {{nome_cliente}} que demonstrou interesse em {{produto}}.
Seja cordial mas objetivo. Destaque os beneficios principais:
- Economia de 30% comparado a concorrencia
- Suporte 24 horas
- Garantia de 12 meses
Objetivo: Agendar uma reuniao com o time comercial.
```

### Cobranca Amigavel

```
Voce e a Julia, do departamento financeiro da empresa XYZ.
Ligue de forma educada para lembrar sobre o pagamento pendente.
Valor: {{valor_divida}} | Vencimento: {{data_vencimento}}
Ofereca opcoes de parcelamento se necessario.
Nunca seja agressivo ou ameacador.
Se o cliente pedir, envie segunda via do boleto por SMS.
```

### Pesquisa de Satisfacao

```
Voce e o assistente de qualidade da empresa XYZ.
Objetivo: Coletar feedback sobre a ultima compra do cliente.
Pergunte:
1. De 0 a 10, qual sua satisfacao geral?
2. O que podemos melhorar?
3. Voce recomendaria para um amigo?
Agradeca pela participacao e oferca um cupom de desconto.
```

## Limites e Consideracoes

| Item | Limite/Info |
| --- | --- |
| Chamadas simultaneas | Depende do plano Retell.ai e Twilio |
| Duracao maxima | Configuravel no Retell (padrao: 30 min) |
| Transcricao | Disponivel apos termino da chamada |
| Gravacao | Requer habilitacao no Retell |
| Latencia | 500-1500ms dependendo do modelo LLM |
| Custo por minuto | Varia por provedor (Twilio + Retell + OpenAI) |
| Numeros internacionais | Suportado via Twilio |
| Regulamentacao | Verificar leis locais sobre ligacoes automatizadas |

## Links Uteis

- [Swagger UI - Documentacao Interativa](https://plataformai.global/api)
- [Health Check - Status do Servidor](https://plataformai.global/health)