# Master IA Oficial

## Overview
Master IA Oficial is a comprehensive WhatsApp and SMS mass messaging control panel with AI automation capabilities. It provides a centralized platform for managing multi-channel campaigns, customer service conversations, contact management (CRM), and AI-driven chatbots using Meta's WhatsApp Business API and Baileys. The project aims to be an all-in-one solution for automated, intelligent communication, offering an intuitive dashboard for businesses. The platform includes an AI-powered lead progression system and a complete Kanban lead management system.

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture
### Technology Stack
- **Frontend**: Next.js 14 (App Router), React, ShadCN UI (Radix UI), Tailwind CSS, TypeScript, Socket.IO.
- **Backend**: Node.js 18+ (Express custom server), Next.js API Routes (REST), Socket.IO 4.8.1, Drizzle ORM (PostgreSQL), JWT authentication.
- **Database**: PostgreSQL (Neon hosted) for primary data, separate PostgreSQL with `pgvector` for AI embeddings, Drizzle Kit.
- **WhatsApp Integration**: Meta Cloud API (v21.0) and Baileys library (7.0.0-rc.6).

### Core Architectural Decisions
- **Dual WhatsApp Connection Strategy**: Supports both Meta API and local Baileys (QR code) connections.
- **Real-time Communication**: Socket.IO for instant updates.
- **AI Personas and Automation Engine**: Persona-based design with provider abstraction (OpenAI, Google Gemini) and RAG capabilities via a vector database.
- **Campaign Queue Management**: Custom queue system with rate limiting and retry logic.
- **Encryption**: AES-256-GCM for sensitive data at rest.
- **Multi-tenant Architecture**: Company-based tenant model ensuring data isolation.
- **Webhook System**: Meta Webhooks with signature verification.
- **Data Flow**: Incoming messages processed via webhooks, stored, and routed through automation; campaigns managed by a queue processor.
- **Performance**: Custom caching, database optimization, and frontend optimizations.
- **Hybrid Campaign Messaging**: Unified wrapper pattern (`sendCampaignMessage`) with provider-specific sub-functions supporting both Meta Cloud API and Baileys connections, including template normalization.
- **Baileys Dedicated UI**: Separate page (`/whatsapp-baileys`) for Baileys-only messaging, with a dedicated API endpoint (`/api/v1/whatsapp-baileys/send`).
- **Enhanced Diagnostics**: SessionManager with `checkAvailability()` method and comprehensive logging throughout message lifecycle.
- **Automatic Lead Progression System**: AI-powered funnel stage migration using a new `move_to_stage` automation action, intelligent qualification detection with weighted scoring, and automatic stage progression after AI responses.
- **Kanban Lead Management System**: Production-ready interactive Kanban with full CRUD operations, drag-and-drop functionality, and mobile-first responsive design, including interactive lead dialogs, KanbanCard components, and robust API endpoints with state management and security.
- **Singleton Pattern Enforcement**: True singleton implementation for `EnhancedCache` and Redis client to prevent memory leaks.
- **Conversations List Pagination Fix**: Smart `limit=0` support with a 10k safety cap for the `/api/v1/conversations` endpoint.
- **Baileys Mass Campaign System**: End-to-end implementation for direct message campaigns without templates, including dedicated UI components, backend API endpoints, and a dual-path campaign sender for template-based and direct messages.
- **Analytics Dashboard System**: Comprehensive real-time analytics with KPI metrics (conversations, leads, conversion rate, avg response time calculated via SQL CTE), time-series charts (day/week/month granularity), funnel visualization, campaign/notification metrics, and SWR data fetching with 30s auto-refresh.
- **Custom Webhooks Integration**: Production-ready webhook system with CRUD management, 10+ event types, HMAC SHA256 signature verification, exponential retry logic (60s â†’ 2h over 5 attempts), background queue worker (60s interval), and Zapier integration documentation with non-blocking dispatches.
- **Template Management System**: Full CRUD interface for message templates with dynamic variable support ({{name}}, {{phone}}, {{email}}, {{company}}), category organization, usage tracking, predefined system templates with edit/delete protection, and regex-based variable extraction for preview rendering.
- **UI/UX Component Library**: Production-ready reusable components including skeleton loaders (table/card/list variants), empty states with CTAs, server-side pagination controls with keyboard navigation (arrows/home/end/left/right) and ARIA live announcements, debounced search inputs (300ms), text highlighting utilities, and centralized toast notification helper with 4 variants (success/error/warning/info). Toast helper pattern: `const notify = useMemo(() => createToastNotifier(toast), [toast])` (MANDATORY useMemo wrapper to prevent re-renders and loops) with dependency arrays always using `[notify]` instead of `[toast]`. **Migration Status (Nov 2025):** Fase 6 Batch 3 completa - 32 componentes migrados (~239 toasts): Fase 1-4 (ContactListsTable, AutomationList, WebhookDialog, CampaignTable+CampaignCard, TemplateDialog, ContactTable, AppHeader, ContactProfile, StartConversationDialog, ImportContactsDialog, FunnelList), Fase 5 (InboxView, ContactDetailsPanel, CreateWhatsAppCampaignDialog, AIPlayground, AutomationRuleForm, MediaUploader, SendTemplateDialog, CreateSMSCampaignDialog, AddContactDialog, MediaLibraryDialog), Fase 6 Batch 1-3 (TeamTable, NotificationsManager, ConnectionsManager, TagsManager, SmsGatewaysManager, WebhooksManager, ApiKeysManager, CreateBaileysCampaignDialog, RagSectionsManager, AiCredentialFormDialog, GalleryClient). Hoisting pattern: parent creates notify once and passes to memoized children via props for shared reference stability. Migration guide: `docs/toast-helper-migration-guide.md`.
- **Progressive Web App (PWA)**: Complete mobile-first PWA implementation with offline support via service worker (Stale-While-Revalidate strategy), app manifest with shortcuts/share target, install prompts with localStorage dismissal, 192x192/512x512 icons, Apple PWA meta tags, and standalone display mode for native app experience.
- **Performance Optimizations (Nov 2025)**: React cache() wrapper for getUserSession eliminating 300-800ms blocking fetch on every navigation, dynamic imports with SSR disabled for ConsoleMonitor and InstallBanner reducing initial bundle size, removal of force-dynamic from main layout enabling RSC streaming, ConnectionStatusBadge popover component for discrete connection monitoring replacing full-page alerts.
- **UX Polish (Nov 2025)**: Hybrid page description strategy (removed from simple pages: Campaigns, Lists, Atendimentos, Dashboard, ConexÃµes, Templates; preserved in complex pages: Automations, AI Agents, Settings, Voice Calls, Roadmap), ConversationListItem layout optimized with min-w-0 and shrink-0 for proper text truncation, ConnectionAlerts card removed from dashboard in favor of header badge.
- **Production Build Readiness (Nov 14, 2025)**: All critical ESLint and TypeScript errors resolved for production deployment. Fixed `react/no-unescaped-entities` errors (4 files), `no-case-declarations` errors (2 files), `prefer-const` violations, TypeScript type safety issues (SemanticType filtering with reduce pattern, baileysSessionManager import aliasing, KanbanCard value type conversion). Build blockers eliminated: 13 errors â†’ 0 errors. **Memory Optimization**: Removed `workerThreads: false` override (prevented worker thread usage, forcing expensive child processes), reduced `cpus: 2 â†’ 1`, removed redundant `npm install` from build:prod script. Deployment configured for Replit Autoscale with custom server.js (Socket.IO + Next.js), production script `start:prod` with NODE_ENV=production. Build command optimized for limited memory environments with `NODE_OPTIONS='--max-old-space-size=1536'`.
- **Automated Cadence System (Nov 14, 2025)**: Production-ready drip campaign automation for re-engaging inactive leads. **Architecture**: 4-table schema (cadence_definitions, cadence_steps, cadence_enrollments, cadence_events) with company-scoped multi-tenant isolation, CadenceService with enrollment/cancellation/stats methods, dual scheduler (daily detector + hourly processor) integrated into server.js startup. **Security**: Multi-tenant isolation enforced via strict company scoping - enrollInCadence validates contact/lead/conversation ownership against cadence.companyId, cancelEnrollmentsByContact requires companyId parameter and filters enrollments/events by company to prevent cross-tenant data leakage. **Automation Flow**: Daily detector identifies inactive conversations (respecting per-cadence triggerAfterDays), auto-enrolls contacts in matching cadences (funnel/stage-specific or general), hourly processor executes pending steps and advances to next step, auto-cancels cadences when contact replies (webhook integration). **APIs**: Full REST CRUD at /api/v1/cadences with enrollment/stats endpoints. **Current Limitations**: Message sending uses MVP stub (logs only) - full integration with campaign-sender pending for next iteration (requires connection lookup, template resolution, and rate limiting).
- **OAuth Authentication System (Nov 14, 2025)**: Production-ready OAuth 2.0 implementation with Google and Facebook providers via NextAuth.js. **Architecture**: Dual authentication system - legacy JWT cookies (`__session`, `session_token`) for app sessions + NextAuth sessions for OAuth flow, custom redirect callback `/api/auth/oauth-callback` bridges OAuth â†’ JWT cookie creation ensuring multi-tenant compatibility. **Schema**: Users table extended with `googleId`, `facebookId`, `googleAccessToken`, `facebookAccessToken` fields (nullable to support password/OAuth/hybrid accounts). **Account Linking**: OAuth login auto-merges with existing email/password accounts via email matching, supports linking multiple OAuth providers to single account post-login. **UI Components**: Login page with dynamic provider detection via `/api/auth/providers-status` endpoint - only shows OAuth buttons for providers with valid credentials configured (adaptive grid: single column for 1 provider, dual columns for 2 providers), FacebookLinkBanner component with localStorage dismissal detection displayed in MainContent when `facebookId` is null. **Flow**: OAuth provider â†’ NextAuth callback â†’ `/api/auth/oauth-callback` â†’ JWT cookie creation â†’ dashboard redirect. **Security**: NEXTAUTH_SECRET for session encryption, httpOnly cookies, SameSite=lax, OAuth credentials managed via Replit secrets. **Provider Setup**: Google Cloud Console OAuth 2.0 Client ID + Facebook App OAuth with redirect URIs configured for `https://entraai.replit.app/api/auth/callback/{google|facebook}`. **Multi-tenant Support**: Each user gets isolated company data (`companyId`) - OAuth credentials are application-wide (single set), but every user has their own account and data separation.
- **Humanized AI Response Delays (Nov 17, 2025)**: Production-ready system to simulate natural human response timing in AI agents. **Architecture**: 4 integer fields added to `aiPersonas` schema (firstResponseMinDelay/Max, followupResponseMinDelay/Max in seconds) with recommended defaults (33-68s for first response, 81-210s for follow-up). **Dual Implementation**: Identical delay logic implemented in both `baileys-session-manager.ts` (for Baileys connections) and `automation-engine.ts` (for Meta Cloud API webhooks) ensuring consistent behavior across all WhatsApp message flows. **Detection Logic**: 24-hour window query determines first vs follow-up responses by checking recent AI messages in conversation history. **Validation**: Triple-layer protection - UI auto-swaps invalid ranges (min > max) via slider interlock, API validates ranges via Zod `.refine()`, and business logic includes defensive guard to swap malformed ranges before calculating delays. **UI Components**: `ResponseDelaySettings` component with range sliders (0-120s for first, 0-600s for follow-up), preset buttons (Muito RÃ¡pido 8-14s, Recomendado 33-68s, Natural 81-210s, Pensativo 233-408s), and integrated into `BehaviorSettings` form. **Logging**: Comprehensive logs with ðŸ•’ emoji marker for easy identification (format: "ðŸ•’ Delay humanizado: {random}s ({type}, range: {min}-{max}s)"). **Implementation Files**: `src/lib/db/schema.ts`, `src/services/baileys-session-manager.ts`, `src/lib/automation-engine.ts`, `src/components/ia/response-delay-settings.tsx`, `src/app/api/v1/ia/personas/route.ts`, `src/app/api/v1/ia/personas/[personaId]/route.ts`.

## External Dependencies
### Third-Party APIs
- **Meta/WhatsApp Business Platform**: Graph API v23.0 for WhatsApp Cloud API.
- **Baileys WhatsApp Library**: `@whiskeysockets/baileys`.

### AI/ML Services
- **OpenAI**: GPT-3.5-turbo, GPT-4 via `@ai-sdk/openai`.
- **Google Generative AI**: Gemini Pro via `@ai-sdk/google`, `@google/generative-ai`.
- **Vector Database**: PostgreSQL with `pgvector` extension.

### Cloud Services
- **AWS Services**: S3 (media storage), CloudFront (CDN), SES v2 (email notifications).
- **Google Cloud Storage**: Alternative file storage.

### Infrastructure
- **PostgreSQL**: Neon (hosted database).
- **Firebase**: (Optional) App Hosting and Secret Manager.
- **Replit**: Development environment, Object Storage.